digraph FlowComparison {
  rankdir=TB;
  node [shape=box, style=rounded, fontname="Arial", fontsize=10];
  edge [fontname="Arial", fontsize=9];

  // ============================================================================
  // ENTRY POINT
  // ============================================================================

  Start [label="HomePage.tsx\nUser selects flow", shape=ellipse, fillcolor="#FFE082", style=filled, fontsize=11];

  FlowTracker [label="flowTracker.ts\nsetActiveFlow()", fillcolor="#FFF59D", style=filled];

  // ============================================================================
  // V1 FLOW
  // ============================================================================

  subgraph cluster_v1 {
    label="V1 Flow - Classic Progressive (/quote/*)";
    style=filled;
    color="#BBDEFB";
    fontsize=13;

    subgraph cluster_v1_screens {
      label="Screens (src/pages/quote/)";
      style=filled;
      color="#E3F2FD";

      V1_1 [label="Screen 1: PrimaryDriverInfo.tsx\n/quote/driver-info\n\nCollects ALL data:\nâ€¢ Driver details (name, DOB, gender)\nâ€¢ Address (line1, city, state, zip)\nâ€¢ Vehicle (year, make, model, VIN)\n\nâš¡ CREATES QUOTE IMMEDIATELY\nðŸ’¾ Writes to DB:\n  â€¢ Quote table\n  â€¢ Party, Person tables\n  â€¢ Vehicle table\n  â€¢ Premium calculated", fillcolor="#42A5F5", style=filled, fontcolor=white];

      V1_2 [label="Screen 2: AdditionalDrivers.tsx\n/quote/additional-drivers/:quoteNumber\n\nAdd/edit additional drivers\n\nðŸ’¾ Writes to DB:\n  â€¢ Person table (additional drivers)\n  â€¢ Party Role table\n  â€¢ Premium recalculated", fillcolor="#64B5F6", style=filled, fontcolor=white];

      V1_3 [label="Screen 3: VehiclesList.tsx\n/quote/vehicles/:quoteNumber\n\nAdd/edit vehicles\n\nðŸ’¾ Writes to DB:\n  â€¢ Vehicle table\n  â€¢ Insurable Object table\n  â€¢ Premium recalculated", fillcolor="#64B5F6", style=filled, fontcolor=white];

      V1_4 [label="Screen 4: VehicleConfirmation.tsx\n/quote/vehicle-confirmation/:quoteNumber\n\nConfirm VIN decode results\n\nðŸ’¾ Reads from DB:\n  â€¢ Vehicle details", fillcolor="#64B5F6", style=filled, fontcolor=white];

      V1_5 [label="Screen 5: CoverageSelection.tsx\n/quote/coverage-selection/:quoteNumber\n\nSelect coverage levels:\nâ€¢ Bodily injury, Property damage\nâ€¢ Collision, Comprehensive\n\nðŸ’¾ Writes to DB:\n  â€¢ Coverage tables (6 types)\n  â€¢ Premium recalculated", fillcolor="#64B5F6", style=filled, fontcolor=white];

      V1_6 [label="Screen 6: QuoteResults.tsx\n/quote/results/:quoteNumber\n\nðŸ“Š Shows final premium\nâ€¢ 6-month total\nâ€¢ Monthly payment\n\nðŸ’¾ Reads from DB:\n  â€¢ Quote with all coverage", fillcolor="#1976D2", style=filled, fontcolor=white];
    }

    V1_Components [label="UI Components:\nâ€¢ AppTemplate (Canary)\nâ€¢ PageHeader (Canary)\nâ€¢ Form components (Canary)\nâ€¢ Standard layout", fillcolor="#90CAF9", style=filled];

    V1_Hooks [label="Uses Shared Hooks:\nâ€¢ useCreateQuote()\nâ€¢ useQuoteByNumber()\nâ€¢ useUpdatePrimaryDriver()\nâ€¢ useUpdateQuoteDrivers()\nâ€¢ useUpdateQuoteVehicles()\nâ€¢ useUpdateQuoteCoverage()", fillcolor="#90CAF9", style=filled];
  }

  // ============================================================================
  // V2 FLOW
  // ============================================================================

  subgraph cluster_v2 {
    label="V2 Flow - Tech Startup Redesign (/quote-v2/*)";
    style=filled;
    color="#E1BEE7";
    fontsize=13;

    V2_Guard [label="RouteGuard Component\nexpectedFlow='tech-startup'\n\nâœ“ Prevents cross-flow navigation", fillcolor="#CE93D8", style=filled, shape=hexagon];

    subgraph cluster_v2_screens {
      label="Screens (src/pages/quote-v2/)";
      style=filled;
      color="#F3E5F5";

      V2_1 [label="Screen 1: GetStarted.tsx\n/quote-v2/get-started\n\nCollects:\nâ€¢ First/Last name\nâ€¢ Address\nâ€¢ Date of birth\n\nðŸ’¾ Stores in sessionStorage\n   'quote-v2-data'", fillcolor="#AB47BC", style=filled, fontcolor=white];

      V2_2 [label="Screen 2: EffectiveDate.tsx\n/quote-v2/effective-date\n\nCollects:\nâ€¢ Coverage start date\n\nðŸ’¾ Stores in sessionStorage\n   'quote-v2-data'", fillcolor="#AB47BC", style=filled, fontcolor=white];

      V2_3 [label="Screen 3: EmailCollection.tsx\n/quote-v2/email-collection\n\nCollects:\nâ€¢ Email address\nâ€¢ Mobile phone\n\nðŸ’¾ Stores in sessionStorage\n   'quote-v2-data'", fillcolor="#AB47BC", style=filled, fontcolor=white];

      V2_4 [label="Screen 4: LoadingPrefill.tsx\n/quote-v2/loading-prefill\n\nâš¡ CREATES QUOTE HERE\nOrchestrates mock services:\nâ€¢ VIN decode (useMockVINDecode)\nâ€¢ MVR lookup (useMockDriverRecord)\nâ€¢ Vehicle value (useMockVehicleValue)\nâ€¢ Insurance history (useMockInsuranceHistory)\n\nðŸŽ¬ Animated loading screen\n\nðŸ’¾ Writes to DB:\n  â€¢ Quote table\n  â€¢ Party, Person tables\n  â€¢ Vehicle table (from VIN decode)\n  â€¢ Driver history (from MVR)\n  â€¢ Premium calculated", fillcolor="#7B1FA2", style="filled,bold", fontcolor=white];

      V2_5 [label="Screen 5: Summary.tsx\n/quote-v2/summary/:quoteNumber\n\nShows:\nâ€¢ Driver summary (with edit modals)\nâ€¢ Vehicle summary (with edit modals)\n\nEdit via:\nâ€¢ EditDriverModal\nâ€¢ EditVehicleModal\nâ€¢ EditVehicleFinancedModal\n\nðŸ’¾ Writes to DB (on edit):\n  â€¢ Person table (driver edits)\n  â€¢ Vehicle table (vehicle edits)\n  â€¢ Premium recalculated", fillcolor="#AB47BC", style=filled, fontcolor=white];

      V2_6 [label="Screen 6: Coverage.tsx\n/quote-v2/coverage/:quoteNumber\n\n3 sections:\n1. Liability (BI/PD limits)\n2. Medical/PIP\n3. Comp/Collision deductibles\n\nðŸ’¾ Writes to DB:\n  â€¢ Coverage tables (6 types)\n  â€¢ Premium recalculated\n  â€¢ PriceSidebar updates", fillcolor="#AB47BC", style=filled, fontcolor=white];

      V2_7 [label="Screen 7: AddOns.tsx\n/quote-v2/add-ons/:quoteNumber\n\nOptional coverage:\nâ€¢ Rental reimbursement\nâ€¢ Roadside assistance\n\nðŸ’¾ Writes to DB:\n  â€¢ Coverage tables (add-ons)\n  â€¢ Premium recalculated\n  â€¢ PriceSidebar updates", fillcolor="#AB47BC", style=filled, fontcolor=white];

      V2_8 [label="Screen 8: LoadingValidation.tsx\n/quote-v2/loading-validation/:quoteNumber\n\nâœ“ Final validation\nðŸŽ¬ Animated loading screen\n\nðŸ’¾ Reads from DB:\n  â€¢ Full quote validation", fillcolor="#AB47BC", style=filled, fontcolor=white];

      V2_9 [label="Screen 9: Review.tsx\n/quote-v2/review/:quoteNumber\n\nðŸ“‹ Final review:\nâ€¢ All details\nâ€¢ Signature capture\nâ€¢ Terms acceptance\n\nðŸ’¾ Writes to DB:\n  â€¢ Signature table\n  â€¢ Quote status updated", fillcolor="#9C27B0", style=filled, fontcolor=white];
    }

    subgraph cluster_v2_custom {
      label="Custom Components (src/pages/quote-v2/components/)";
      style=filled;
      color="#CE93D8";

      V2_Layout [label="TechStartupLayout.tsx\n+ TechStartupLayout.css\n\nâ€¢ Provides QuoteContext\nâ€¢ Purple gradient background\nâ€¢ Card-based layout\nâ€¢ Wraps all v2 screens", fillcolor="#8E24AA", style=filled, fontcolor=white];

      V2_Sidebar [label="PriceSidebar.tsx\n\nðŸ“Š Sticky price display:\nâ€¢ 6-month total\nâ€¢ Monthly payment\nâ€¢ Real-time updates via\n  useRecalculateQuote()", fillcolor="#8E24AA", style=filled, fontcolor=white];

      V2_Context [label="QuoteContext.tsx\n(contexts/)\n\nâ€¢ Provides quote data\nâ€¢ recalculatePremium()\nâ€¢ Consumed by all screens", fillcolor="#6A1B9A", style=filled, fontcolor=white];
    }

    V2_Hooks [label="Uses Shared Hooks +:\nâ€¢ useCreateQuote()\nâ€¢ useQuoteByNumber()\nâ€¢ useUpdateQuoteDrivers()\nâ€¢ useUpdateQuoteVehicles()\nâ€¢ useUpdateQuoteCoverage()\nâ€¢ useRecalculateQuote() âš¡\nâ€¢ useMockVINDecode() âš¡\nâ€¢ useMockDriverRecord() âš¡", fillcolor="#BA68C8", style=filled];
  }

  // ============================================================================
  // SHARED INFRASTRUCTURE
  // ============================================================================

  subgraph cluster_shared {
    label="Shared Infrastructure (100% Common)";
    style=filled;
    color="#C8E6C9";
    fontsize=13;

    subgraph cluster_frontend_shared {
      label="Frontend Shared (src/)";
      style=filled;
      color="#E8F5E9";

      SharedHooks [label="hooks/useQuote.ts\nTanStack Query Hooks:\n\nâ€¢ useQuote()\nâ€¢ useQuoteByNumber()\nâ€¢ useCreateQuote()\nâ€¢ useUpdatePrimaryDriver()\nâ€¢ useUpdateQuoteDrivers()\nâ€¢ useUpdateQuoteVehicles()\nâ€¢ useUpdateQuoteCoverage()\nâ€¢ useRecalculateQuote()", fillcolor="#66BB6A", style=filled, fontcolor=white];

      ApiClient [label="services/quote-api.ts\nHTTP Client:\n\nâ€¢ createQuote()\nâ€¢ getQuoteById()\nâ€¢ getQuoteByNumber()\nâ€¢ updatePrimaryDriver()\nâ€¢ updateDrivers()\nâ€¢ updateVehicles()\nâ€¢ updateCoverage()\nâ€¢ recalculateQuote()", fillcolor="#66BB6A", style=filled, fontcolor=white];

      MockHooks [label="hooks/useMockServices.ts\n\nâ€¢ useMockVINDecode()\nâ€¢ useMockInsuranceHistory()\nâ€¢ useMockVehicleValue()\nâ€¢ useMockDriverRecord()", fillcolor="#66BB6A", style=filled, fontcolor=white];
    }

    subgraph cluster_backend {
      label="Backend (backend/src/)";
      style=filled;
      color="#E8F5E9";

      Controller [label="api/routes/quotes.controller.ts\nREST Endpoints:\n\nPOST   /api/v1/quotes\nGET    /api/v1/quotes/:id\nGET    /api/v1/quotes/reference/:number\nPUT    /api/v1/quotes/:number/primary-driver\nPUT    /api/v1/quotes/:number/drivers\nPUT    /api/v1/quotes/:number/vehicles\nPUT    /api/v1/quotes/:number/coverage", fillcolor="#4CAF50", style=filled, fontcolor=white];

      QuoteService [label="services/quote/quote.service.ts\nBusiness Logic:\n\nâ€¢ Quote creation\nâ€¢ Quote updates\nâ€¢ Validation\nâ€¢ Calls RatingEngine", fillcolor="#388E3C", style=filled, fontcolor=white];

      RatingEngine [label="services/rating-engine/\nPremium Calculation:\n\nâ€¢ Base rates by state\nâ€¢ Age/gender factors\nâ€¢ Vehicle rating\nâ€¢ Multi-vehicle discount\nâ€¢ Discounts & surcharges", fillcolor="#2E7D32", style=filled, fontcolor=white];

      MockServices [label="services/mock-services/\nSimulated Integrations:\n\nâ€¢ VIN decoder\nâ€¢ MVR lookup\nâ€¢ Vehicle valuation\nâ€¢ Insurance history\nâ€¢ Email service", fillcolor="#2E7D32", style=filled, fontcolor=white];
    }

    DB [label="Database\ndatabase/schema/\n\n31 OMG-compliant tables:\nâ€¢ Quote, Policy, Coverage\nâ€¢ Party, Person, Vehicle\nâ€¢ Account, Payment, Claim\nâ€¢ Rating tables, etc.\n\nNeon PostgreSQL", shape=cylinder, fillcolor="#1B5E20", style=filled, fontcolor=white];
  }

  // ============================================================================
  // CONNECTIONS - Entry
  // ============================================================================

  Start -> FlowTracker [label="User clicks flow"];
  FlowTracker -> V1_1 [label="setActiveFlow('classic')\nNavigate to /quote/driver-info", color="#1976D2", penwidth=2];
  FlowTracker -> V2_Guard [label="setActiveFlow('tech-startup')\nNavigate to /quote-v2/*", color="#6A1B9A", penwidth=2];
  V2_Guard -> V2_1 [label="Route allowed", color="#6A1B9A", penwidth=1.5];

  // ============================================================================
  // CONNECTIONS - V1 Screen Flow
  // ============================================================================

  V1_1 -> V1_2 [label="Navigate with\nquoteNumber", color="#1976D2", penwidth=1.5];
  V1_2 -> V1_3 [label="Navigate", color="#1976D2", penwidth=1.5];
  V1_3 -> V1_4 [label="Navigate", color="#1976D2", penwidth=1.5];
  V1_4 -> V1_5 [label="Navigate", color="#1976D2", penwidth=1.5];
  V1_5 -> V1_6 [label="Navigate", color="#1976D2", penwidth=1.5];

  // ============================================================================
  // CONNECTIONS - V2 Screen Flow
  // ============================================================================

  V2_1 -> V2_2 [label="sessionStorage\n'quote-v2-data'", color="#6A1B9A", penwidth=1.5];
  V2_2 -> V2_3 [label="sessionStorage", color="#6A1B9A", penwidth=1.5];
  V2_3 -> V2_4 [label="sessionStorage", color="#6A1B9A", penwidth=1.5];
  V2_4 -> V2_5 [label="Navigate with\nquoteNumber", color="#6A1B9A", penwidth=1.5];
  V2_5 -> V2_6 [label="Navigate", color="#6A1B9A", penwidth=1.5];
  V2_6 -> V2_7 [label="Navigate", color="#6A1B9A", penwidth=1.5];
  V2_7 -> V2_8 [label="Navigate", color="#6A1B9A", penwidth=1.5];
  V2_8 -> V2_9 [label="Navigate", color="#6A1B9A", penwidth=1.5];

  // ============================================================================
  // CONNECTIONS - V1 to Shared
  // ============================================================================

  V1_1 -> SharedHooks [label="useCreateQuote()\nuseUpdatePrimaryDriver()", color="#1976D2", style=dotted];
  V1_2 -> SharedHooks [label="useUpdateQuoteDrivers()", color="#1976D2", style=dotted];
  V1_3 -> SharedHooks [label="useUpdateQuoteVehicles()", color="#1976D2", style=dotted];
  V1_5 -> SharedHooks [label="useUpdateQuoteCoverage()", color="#1976D2", style=dotted];

  // ============================================================================
  // CONNECTIONS - V2 to Shared
  // ============================================================================

  V2_4 -> SharedHooks [label="useCreateQuote()", color="#6A1B9A", style=dotted];
  V2_4 -> MockHooks [label="All mock hooks", color="#6A1B9A", style=dotted];
  V2_5 -> SharedHooks [label="useQuoteByNumber()\nuseUpdateDrivers()\nuseUpdateVehicles()", color="#6A1B9A", style=dotted];
  V2_6 -> SharedHooks [label="useUpdateQuoteCoverage()\nuseRecalculateQuote()", color="#6A1B9A", style=dotted];
  V2_7 -> SharedHooks [label="useUpdateQuoteCoverage()\nuseRecalculateQuote()", color="#6A1B9A", style=dotted];

  V2_Layout -> V2_Context [label="Provides", color="#6A1B9A"];
  V2_Sidebar -> V2_Context [label="Consumes", color="#6A1B9A"];
  V2_Layout -> V2_1 [label="Wraps", color="#6A1B9A", style=dotted];
  V2_Layout -> V2_5 [label="Wraps", color="#6A1B9A", style=dotted];
  V2_Layout -> V2_6 [label="Wraps", color="#6A1B9A", style=dotted];

  // ============================================================================
  // CONNECTIONS - Shared Infrastructure
  // ============================================================================

  SharedHooks -> ApiClient [label="Wraps HTTP calls", color="#2E7D32"];
  MockHooks -> ApiClient [label="Wraps HTTP calls", color="#2E7D32"];
  ApiClient -> Controller [label="HTTP requests", color="#2E7D32"];
  Controller -> QuoteService [label="Delegates to service", color="#2E7D32"];
  QuoteService -> RatingEngine [label="Calculate premium", color="#2E7D32"];
  QuoteService -> DB [label="CRUD operations", color="#2E7D32"];
  RatingEngine -> DB [label="Read rating tables", color="#2E7D32"];
  MockServices -> DB [label="Write mock data", color="#2E7D32"];
  Controller -> MockServices [label="Calls for prefill", color="#2E7D32", style=dashed];

  // ============================================================================
  // POST-QUOTE FLOWS (SHARED BY BOTH V1 AND V2)
  // ============================================================================

  subgraph cluster_post_quote {
    label="Post-Quote Flows (Shared by Both V1 and V2)";
    style=filled;
    color="#FFF9C4";
    fontsize=13;

    subgraph cluster_binding {
      label="Policy Binding";
      style=filled;
      color="#FFF59D";

      Binding [label="Payment & Binding\n(Both flows proceed here)\n\nPOST /api/v1/policies/bind\n\nCollects:\nâ€¢ Payment method (card/bank)\nâ€¢ Billing frequency (monthly/6-month)\nâ€¢ Card details (number, expiry, CVV)\n\nðŸ’¾ Writes to DB:\n  â€¢ Policy table (from quote)\n  â€¢ Agreement table\n  â€¢ Account table\n  â€¢ Payment table\n  â€¢ Document generation triggered", fillcolor="#FFD54F", style=filled];
    }

    subgraph cluster_documents {
      label="Document Generation";
      style=filled;
      color="#FFF59D";

      DocGen [label="Document Service\nbackend/src/services/document-service/\n\nGenerates PDF documents:\nâ€¢ Policy Declarations Page\nâ€¢ Coverage Summary\nâ€¢ Terms & Conditions\nâ€¢ ID Cards (per vehicle)\n\nðŸ’¾ Writes to DB:\n  â€¢ Document table\n  â€¢ Links to Policy\n\nGET /api/v1/documents/:id", fillcolor="#FFB300", style=filled];
    }

    subgraph cluster_portal {
      label="Self-Service Portal";
      style=filled;
      color="#FFF59D";

      Portal_Entry [label="Portal Access\n/portal/:policyNumber\n\nâš ï¸ NO AUTHENTICATION (Demo mode)\nAccess via URL with policy number\n\nExample:\n/portal/POL-ABC123", fillcolor="#FF6F00", style=filled, fontcolor=white];

      Portal_Dashboard [label="Dashboard Page\nsrc/pages/portal/Dashboard.tsx\n\nGET /api/v1/portal/:policyNumber/dashboard\n\nShows:\nâ€¢ Policy status & expiry\nâ€¢ Coverage summary\nâ€¢ Recent payments\nâ€¢ Active claims\n\nðŸ’¾ Reads from DB:\n  â€¢ Policy, Coverage tables\n  â€¢ Payment table\n  â€¢ Claim table", fillcolor="#FFA726", style=filled];

      Portal_Policy [label="Policy Details Page\nsrc/pages/portal/PolicyDetails.tsx\n\nGET /api/v1/portal/:policyNumber/policy\n\nShows:\nâ€¢ Full policy details\nâ€¢ All drivers & vehicles\nâ€¢ Coverage breakdown\nâ€¢ Download documents\n\nðŸ’¾ Reads from DB:\n  â€¢ Policy, Agreement tables\n  â€¢ Person, Vehicle tables\n  â€¢ Coverage tables\n  â€¢ Document table", fillcolor="#FFA726", style=filled];

      Portal_Billing [label="Billing Page\nsrc/pages/portal/Billing.tsx\n\nGET /api/v1/portal/:policyNumber/billing\n\nShows:\nâ€¢ Payment history\nâ€¢ Next payment due\nâ€¢ Billing frequency\nâ€¢ Payment method\n\nðŸ’¾ Reads from DB:\n  â€¢ Payment table\n  â€¢ Account table", fillcolor="#FFA726", style=filled];

      Portal_Claims [label="Claims Page\nsrc/pages/portal/Claims.tsx\n\nGET /api/v1/portal/:policyNumber/claims\n\nShows:\nâ€¢ Active claims\nâ€¢ Claim status\nâ€¢ Claim history\nâ€¢ File new claim (future)\n\nðŸ’¾ Reads from DB:\n  â€¢ Claim table\n  â€¢ Claim Party Role table\n  â€¢ Claim Event table", fillcolor="#FFA726", style=filled];
    }
  }

  // ============================================================================
  // CONNECTIONS - V1/V2 to Binding
  // ============================================================================

  V1_6 -> Binding [label="User clicks\n'Proceed to bind'", color="#1976D2", penwidth=2];
  V2_9 -> Binding [label="User clicks\n'Proceed to bind'", color="#6A1B9A", penwidth=2];

  // ============================================================================
  // CONNECTIONS - Binding to Documents & Portal
  // ============================================================================

  Binding -> DocGen [label="Triggers on\npolicy creation", color="#F57F17", penwidth=1.5];
  Binding -> Portal_Entry [label="Policy created\nUser can access portal", color="#F57F17", penwidth=1.5];

  DocGen -> DB [label="Write documents", color="#F57F17", style=dashed];

  Portal_Entry -> Portal_Dashboard [label="Navigate to\n/portal/:policyNumber/dashboard", color="#FF6F00", penwidth=1.5];
  Portal_Dashboard -> Portal_Policy [label="Navigate", color="#FF6F00"];
  Portal_Dashboard -> Portal_Billing [label="Navigate", color="#FF6F00"];
  Portal_Dashboard -> Portal_Claims [label="Navigate", color="#FF6F00"];

  Portal_Policy -> DB [label="Read policy data", color="#FF6F00", style=dotted];
  Portal_Billing -> DB [label="Read billing data", color="#FF6F00", style=dotted];
  Portal_Claims -> DB [label="Read claims data", color="#FF6F00", style=dotted];
  Portal_Dashboard -> DB [label="Read dashboard data", color="#FF6F00", style=dotted];

  Portal_Policy -> DocGen [label="Download\nPDF documents", color="#FF6F00", style=dashed];

  // ============================================================================
  // LEGEND
  // ============================================================================

  subgraph cluster_legend {
    label="Legend";
    style=filled;
    color=white;
    fontsize=11;

    L1 [label="V1 Flow", fillcolor="#64B5F6", style=filled, fontcolor=white];
    L2 [label="V2 Flow", fillcolor="#AB47BC", style=filled, fontcolor=white];
    L3 [label="Shared Code", fillcolor="#66BB6A", style=filled, fontcolor=white];
    L4 [label="Post-Quote (Binding/Portal)", fillcolor="#FFD54F", style=filled];

    L1 -> L2 [label="Solid = Navigation/Flow", style=solid];
    L2 -> L3 [label="Dotted = Uses/Calls", style=dotted];
    L3 -> L4 [label="Dashed = Triggers/Downloads", style=dashed];
  }
}
