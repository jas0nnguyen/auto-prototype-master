# Implementation Plan: Policy Document Rendering and Download

**Branch**: `003-portal-document-download` | **Date**: 2025-11-09 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-portal-document-download/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

This feature enables policyholders to view and download insurance policy documents (declarations pages, policy documents, insurance ID cards) from their self-service portal. The system generates PDFs by merging policyholder data from the database into HTML templates using a template engine (Handlebars), converts HTML to PDF using a headless browser (Playwright), and stores generated documents in Vercel Blob storage. Users can download documents with a single click, view document history, and automatically receive updated documents when policy changes occur.

**Technical Approach**:
- **Template Engine**: Handlebars for merging policy data into HTML templates
- **PDF Generation**: Playwright (already in dependencies) for HTML-to-PDF conversion with full CSS support
- **Storage**: Vercel Blob for serverless document storage
- **Document Lifecycle**: Generate on policy creation/update, store with metadata, serve via portal API

## Technical Context

**Language/Version**: TypeScript 5.8+ (strict mode enabled)
**Primary Dependencies**:
- **Frontend**: React 18, TanStack Query, React Router, Canary Design System
- **Backend**: NestJS, Drizzle ORM, Neon PostgreSQL
- **Document Generation**: Handlebars (template engine), Playwright (HTML-to-PDF), @vercel/blob (storage)
**Storage**:
- **Database**: Neon PostgreSQL (policy data, document metadata)
- **File Storage**: Vercel Blob (generated PDF files)
**Testing**: Vitest (frontend), Jest (backend), Playwright (E2E, also used for PDF generation)
**Target Platform**: Vercel serverless functions (backend), Vercel static hosting (frontend)
**Project Type**: Web application (fullstack: React frontend + NestJS backend)
**Performance Goals**:
- Document generation: <15 seconds for 4-vehicle policy
- Document download: <5 seconds for 2MB file
- Portal document list load: <1 second
- Support 100 concurrent document generation requests
**Constraints**:
- PDF generation must work in Vercel serverless environment (10-second function timeout by default, extendable to 60s)
- Document storage costs must remain under $50/month for 10,000 policies
- Generated PDFs must be accessible and properly formatted (WCAG 2.1 AA compliance)
- Template data must be sanitized to prevent HTML injection
**Scale/Scope**:
- Support 10,000+ policies with avg 5 documents each (50,000 documents)
- Handle 10+ vehicles per policy (multi-page documents)
- Version tracking for document history
- 3 document types initially (declarations, policy, ID cards)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Principle I: Design System First ✅ PASS

**Assessment**: Portal UI for document list and download buttons will use Canary Design System components exclusively.

**Implementation**:
- Document list: Use Canary Table or Card components
- Download buttons: Use Canary Button component
- Loading states: Use Canary Spinner component
- Error messages: Use Canary Alert component
- No custom CSS required beyond layout

**Justification**: Full compliance - all UI leverages existing design system.

---

### Principle II: OMG Standards Compliance ✅ PASS (with extension)

**Assessment**: Document entity aligns with OMG P&C Data Model patterns. The OMG standard does not prescribe specific document management entities, but Document fits naturally into the Agreement/Policy context.

**OMG Alignment**:
- **Document** entity follows OMG Party Role pattern (documents belong to policies)
- **Document Type** enumeration follows OMG type classification approach
- **Document Metadata** (generation date, version) aligns with OMG temporal tracking
- **Document Status** (generating/ready/failed/superseded) follows OMG state management

**Extension Justification**: Document entity is a standard insurance system component for policy lifecycle management. Maps to OMG Agreement concept as "policy evidence artifacts."

---

### Principle III: Production-Ready Patterns ✅ PASS

**Assessment**: All production patterns maintained except authentication (demo mode exception per Constitution v1.1.0).

**Production Patterns**:
- ✅ **Error Handling**: PDF generation failures retry 3x, user-friendly messages displayed
- ✅ **Security**: Document access restricted to policyholder (policy number verification)
- ✅ **Data Validation**: HTML template sanitization prevents injection
- ✅ **Loading States**: Generation status indicators, download progress
- ✅ **Edge Cases**: Missing data, concurrent generation, large policies handled
- ✅ **Audit Trail**: Document access logged (who downloaded what when)
- ✅ **Authentication**: Demo mode uses URL-based policy number access (same pattern as existing portal)

**Demo Mode Authentication** (Constitutional Exception):
- **Implementation**: URL-based policy number access (e.g., `/portal/DZQV87Z4FH/documents`)
- **Pattern**: Matches existing portal authentication (Feature 001, User Story 3)
- **Validation**: Policy number verified against database, 404 if not found
- **NOT IMPLEMENTED**: Session management, OAuth, JWT tokens - these are OUT OF SCOPE for demo
- **Documentation Only**: Production migration path documented in quickstart.md for future reference (NOT a requirement for this feature)

---

### Principle IV: User Story-Driven Development ✅ PASS

**Assessment**: Feature spec defines 3 independently testable user stories with clear priorities.

**User Stories**:
- **P1**: View and Download Policy Documents (core value, MVP)
- **P2**: Generate Documents On-Demand (policy change synchronization)
- **P3**: Document History and Versioning (audit trail, transparency)

**Independence Verification**:
- P1 deliverable standalone: User can download pre-generated documents
- P2 independent of P3: On-demand generation works without versioning
- P3 independent of P2: History can be implemented with manual regeneration

**Foundational Infrastructure**:
- Database schema for Document entity (blocking for all stories)
- Vercel Blob configuration (blocking for all stories)
- PDF generation service (blocking for all stories)
- Template engine integration (blocking for all stories)

---

### Principle V: Type Safety ✅ PASS

**Assessment**: Full TypeScript coverage with strict mode.

**Type Safety Plan**:
- `Document` entity interface with all fields typed
- `DocumentTemplate` interface for template metadata
- `DocumentGenerationRequest` / `DocumentGenerationResponse` DTOs
- Handlebars template data interfaces for type-safe merging
- Vercel Blob SDK types for storage operations
- No `any` types except for Playwright page object (justified third-party)

**Compile-Time Validation**: All document operations type-checked before runtime.

---

### Principle VI: Data Persistence ✅ PASS

**Assessment**: Document metadata persisted in Neon, files in Vercel Blob, state transitions tracked.

**Persistence Model**:
- **Documents Table**: Stores document metadata (type, version, status, policy_id, vehicle_id, storage_url)
- **State Transitions**: GENERATING → READY → SUPERSEDED (with audit logging)
- **File Storage**: Generated PDFs in Vercel Blob with unique keys
- **Retention**: Documents retained per policy lifecycle (7 years after expiration)

**State Management**:
- GENERATING: Document generation in progress
- READY: Document available for download
- FAILED: Generation failed after retries
- SUPERSEDED: Newer version exists, but historical copy retained

---

### Constitution Compliance Summary

**Result**: ✅ **PASS** - All 6 principles satisfied

**Violations**: None

**Demo Exceptions**: Authentication (URL-based access) - explicitly allowed per Constitution v1.1.0 with production migration path documented.

---

## Project Structure

### Documentation (this feature)

```
specs/003-portal-document-download/
├── spec.md              # Feature specification with user stories
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output: Technology research and decisions
├── data-model.md        # Phase 1 output: Document entity schema
├── quickstart.md        # Phase 1 output: Developer onboarding
├── contracts/           # Phase 1 output: API contracts (OpenAPI specs)
│   └── document-api.yaml
├── templates/           # HTML templates and data mapping
│   ├── declarations-page.html     # User-provided template
│   └── data-mapping.md            # Template variable mapping to OMG entities
├── checklists/          # Quality assurance checklists
│   └── requirements.md            # Spec validation checklist
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

**Structure Decision**: Web application (Option 2) - This feature extends the existing fullstack architecture with backend document services and frontend portal pages.

```
backend/
├── src/
│   ├── entities/
│   │   └── document.entity.ts              # Document entity (OMG-aligned)
│   ├── services/
│   │   ├── document-service/
│   │   │   ├── document.service.ts         # Document CRUD operations
│   │   │   ├── document.module.ts          # NestJS module
│   │   │   ├── template.service.ts         # Handlebars template compilation
│   │   │   ├── pdf-generator.service.ts    # Playwright HTML-to-PDF
│   │   │   └── storage.service.ts          # Vercel Blob operations
│   │   └── quote-service/
│   │       └── quote.service.ts            # MODIFY: Trigger doc generation on policy changes
│   ├── api/
│   │   └── routes/
│   │       └── documents.controller.ts     # Document API endpoints
│   └── utils/
│       ├── document-formatters.ts          # Date/currency/name formatting
│       └── template-validators.ts          # HTML sanitization
├── tests/
│   ├── unit/
│   │   ├── document.service.spec.ts
│   │   ├── pdf-generator.service.spec.ts
│   │   └── template.service.spec.ts
│   └── integration/
│       └── document-generation.spec.ts     # End-to-end generation test
└── templates/
    └── declarations-page.hbs               # Compiled Handlebars template

frontend/
├── src/
│   ├── pages/
│   │   └── portal/
│   │       └── Documents.tsx               # MODIFY: Add document list/download UI
│   ├── services/
│   │   └── document-api.ts                 # Document API client
│   ├── hooks/
│   │   └── useDocuments.ts                 # TanStack Query hooks for documents
│   └── types/
│       └── document.types.ts               # Document TypeScript interfaces
└── tests/
    └── pages/
        └── portal/
            └── Documents.spec.tsx          # Document page tests

database/
└── schema/
    └── document.schema.ts                  # Drizzle schema for documents table
```

**Integration Points**:
- **Policy Binding**: When policy status → IN_FORCE, trigger document generation
- **Policy Changes**: When coverage/vehicle/party updated, regenerate affected documents
- **Portal Access**: Documents page added to portal sidebar navigation
- **API Gateway**: Documents API integrated into existing NestJS app module

---

## Complexity Tracking

*No constitution violations - this section intentionally empty.*

This feature maintains all constitution principles:
- Uses existing Canary Design System components
- Extends OMG data model with standard Document entity
- Follows production-ready patterns (error handling, validation, security)
- Organized by 3 prioritized user stories
- Full TypeScript type safety
- Data persisted in Neon + Vercel Blob

---

## Phase 0: Research & Technology Selection

### Research Questions

1. **HTML-to-PDF Library Selection**
   - Question: Which library provides best CSS support and Vercel compatibility?
   - Options: Puppeteer, Playwright, pdf-lib, pdfmake
   - Decision Criteria: CSS @page support, table rendering, serverless compatibility, bundle size

2. **Vercel Blob Integration**
   - Question: How to configure Vercel Blob for document storage?
   - Research: API authentication, file upload patterns, URL generation, cost structure
   - Decision Criteria: Ease of integration, CDN performance, cost at scale

3. **Template Engine Selection**
   - Question: Which template engine for Handlebars syntax?
   - Options: Handlebars.js, Mustache, Nunjucks
   - Decision Criteria: Syntax compatibility, security features, TypeScript support

4. **Serverless PDF Generation**
   - Question: How to run Playwright in Vercel serverless functions?
   - Research: Chromium binary requirements, function timeout limits, memory constraints
   - Decision Criteria: Cold start time, execution time, resource usage

5. **Document Versioning Strategy**
   - Question: How to handle superseded documents?
   - Options: Soft delete, archive table, version column
   - Decision Criteria: Query performance, storage cost, audit trail completeness

### Research Output

See [research.md](./research.md) for detailed findings and decisions.

---

## Phase 1: Design Artifacts

### 1. Data Model

**Output**: [data-model.md](./data-model.md)

**Contents**:
- Document entity schema (Drizzle TypeScript)
- DocumentTemplate entity (optional: initially templates in code)
- Document state transition diagram
- Database indexes for query performance
- Relationships to Policy, Vehicle entities

**Key Decisions**:
- Document storage: Metadata in PostgreSQL, files in Vercel Blob
- Version tracking: Sequential version numbers per policy+document_type
- Status enum: GENERATING, READY, FAILED, SUPERSEDED
- Foreign keys: policy_id (required), vehicle_id (nullable for policy-level docs)

---

### 2. API Contracts

**Output**: [contracts/document-api.yaml](./contracts/document-api.yaml)

**Endpoints**:

```yaml
GET /api/v1/portal/{policyNumber}/documents
  - List all documents for a policy
  - Query params: document_type (filter), version (filter)
  - Response: Array of DocumentMetadata

GET /api/v1/portal/{policyNumber}/documents/{documentId}/download
  - Download a specific document
  - Response: Redirects to Vercel Blob signed URL (expires in 1 hour)
  - Logs download event for audit trail

POST /api/v1/documents/generate
  - Trigger document generation (internal API, not exposed to frontend)
  - Request: { policy_id, document_types, trigger_reason }
  - Response: { job_id, status, estimated_completion }
  - Used by policy service on policy changes

GET /api/v1/documents/{documentId}/status
  - Check document generation status
  - Response: { status, progress, error_message }
  - Polling endpoint for real-time status updates
```

**Authentication**: Policy number verification (demo mode)

**Error Responses**:
- 404: Policy not found or document not found
- 403: Unauthorized access to document
- 500: Generation failed
- 503: Generation in progress (retry after X seconds)

---

### 3. Quickstart Guide

**Output**: [quickstart.md](./quickstart.md)

**Contents**:
- Feature overview and architecture diagram
- Local development setup (Vercel Blob env vars)
- How to add new document templates
- Testing document generation locally
- Production deployment checklist
- Production migration path (authentication, email delivery)

---

## Phase 2: Task Generation

**Command**: `/speckit.tasks` (separate command, not part of /speckit.plan)

**Output**: [tasks.md](./tasks.md)

**Organization**: Tasks grouped by user story (P1, P2, P3) with foundational infrastructure tasks identified as blocking prerequisites.

---

## Next Steps

1. ✅ **Specification Complete**: spec.md approved with 3 user stories
2. ✅ **Planning Complete**: This plan defines technical approach and structure
3. ⏭️ **Research Phase**: Execute Phase 0 research tasks (create research.md)
4. ⏭️ **Design Phase**: Execute Phase 1 design artifacts (data-model.md, contracts, quickstart)
5. ⏭️ **Task Generation**: Run `/speckit.tasks` to generate dependency-ordered task list
6. ⏭️ **Implementation**: Execute tasks from tasks.md by user story priority

---

**Plan Status**: ✅ READY FOR RESEARCH PHASE

This plan has been validated against all 6 constitution principles and is ready for execution.
