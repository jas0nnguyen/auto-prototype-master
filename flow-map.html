<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Insurance Flow Map - V1 vs V2 Comparison</title>
    <script src="https://unpkg.com/@hpcc-js/wasm/dist/graphviz.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1976D2 0%, #6A1B9A 100%);
            color: white;
            padding: 30px 40px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
            line-height: 1.6;
        }

        .controls {
            padding: 20px 40px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #1976D2;
            color: white;
        }

        .btn-primary:hover {
            background: #1565C0;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: white;
            color: #495057;
            border: 1px solid #dee2e6;
        }

        .btn-secondary:hover {
            background: #f8f9fa;
        }

        .zoom-controls {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .zoom-label {
            color: #6c757d;
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .content {
            padding: 40px;
            background: white;
        }

        .graph-container {
            width: 100%;
            overflow: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #ffffff;
            min-height: 600px;
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
            position: relative;
            cursor: grab;
        }

        .graph-container:active {
            cursor: grabbing;
        }

        #graph {
            transition: transform 0.2s;
            transform-origin: top left;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #6c757d;
            width: 100%;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1976D2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-panel {
            background: #e7f3ff;
            border-left: 4px solid #1976D2;
            padding: 20px;
            margin-top: 20px;
            border-radius: 6px;
        }

        .info-panel h3 {
            color: #1976D2;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .info-panel ul {
            list-style: none;
            padding-left: 0;
        }

        .info-panel li {
            padding: 6px 0;
            color: #495057;
            line-height: 1.6;
        }

        .info-panel li::before {
            content: "‚Üí";
            color: #1976D2;
            font-weight: bold;
            display: inline-block;
            width: 20px;
        }

        .color-key {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        .color-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-box {
            width: 40px;
            height: 30px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .color-label {
            font-size: 14px;
            color: #495057;
        }

        .footer {
            padding: 20px 40px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            text-align: center;
            color: #6c757d;
            font-size: 14px;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #f5c6cb;
            margin: 20px;
        }

        .error-message h3 {
            margin-bottom: 10px;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .container {
                box-shadow: none;
            }
            .controls, .footer {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Auto Insurance Flow Map</h1>
            <p>Complete comparison of V1 Classic Progressive Flow vs V2 Tech Startup Redesign Flow</p>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="resetZoom()">
                <span>üîÑ</span> Reset View
            </button>
            <button class="btn btn-secondary" onclick="downloadSVG()">
                <span>‚¨áÔ∏è</span> Download SVG
            </button>
            <button class="btn btn-secondary" onclick="window.print()">
                <span>üñ®Ô∏è</span> Print
            </button>

            <div class="zoom-controls">
                <span class="zoom-label">Zoom:</span>
                <button class="btn btn-secondary" onclick="zoomOut()">‚àí</button>
                <button class="btn btn-secondary" onclick="zoomIn()">+</button>
            </div>
        </div>

        <div class="content">
            <div class="graph-container" id="graphContainer">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Rendering flow diagram...</p>
                </div>
            </div>

            <div class="info-panel">
                <h3>üìä Flow Map Features</h3>
                <ul>
                    <li><strong>V1 Flow (Blue):</strong> Classic Progressive - 6 screens, quote created immediately on first screen</li>
                    <li><strong>V2 Flow (Purple):</strong> Tech Startup Redesign - 9 screens, quote created on loading screen with mock prefill</li>
                    <li><strong>Shared Infrastructure (Green):</strong> 100% common backend, API, database, and hooks</li>
                    <li><strong>Post-Quote Flows (Yellow):</strong> Binding, document generation, and self-service portal (shared by both flows)</li>
                    <li><strong>Database:</strong> 31 OMG P&C Data Model v1.0 compliant tables in Neon PostgreSQL</li>
                </ul>
            </div>

            <div class="color-key">
                <div class="color-item">
                    <div class="color-box" style="background: #42A5F5;"></div>
                    <div class="color-label">V1 Primary Screen</div>
                </div>
                <div class="color-item">
                    <div class="color-box" style="background: #64B5F6;"></div>
                    <div class="color-label">V1 Secondary Screens</div>
                </div>
                <div class="color-item">
                    <div class="color-box" style="background: #AB47BC;"></div>
                    <div class="color-label">V2 Screens</div>
                </div>
                <div class="color-item">
                    <div class="color-box" style="background: #7B1FA2;"></div>
                    <div class="color-label">V2 Loading/Prefill</div>
                </div>
                <div class="color-item">
                    <div class="color-box" style="background: #66BB6A;"></div>
                    <div class="color-label">Shared Code</div>
                </div>
                <div class="color-item">
                    <div class="color-box" style="background: #FFD54F;"></div>
                    <div class="color-label">Binding & Portal</div>
                </div>
            </div>
        </div>

        <div class="footer">
            Generated from flow map.dot ‚Ä¢ Auto Insurance Prototype ‚Ä¢ OMG P&C Data Model v1.0 Compliant
        </div>
    </div>

    <script>
        let currentZoom = 1;
        let svgContent = '';
        let graphviz = null;

        // DOT source embedded
        const dotSource = `digraph FlowComparison {
  rankdir=TB;
  node [shape=box, style=rounded, fontname="Arial", fontsize=10];
  edge [fontname="Arial", fontsize=9];

  Start [label="HomePage.tsx\\nUser selects flow", shape=ellipse, fillcolor="#FFE082", style=filled, fontsize=11];
  FlowTracker [label="flowTracker.ts\\nsetActiveFlow()", fillcolor="#FFF59D", style=filled];

  subgraph cluster_v1 {
    label="V1 Flow - Classic Progressive (/quote/*)";
    style=filled;
    color="#BBDEFB";
    fontsize=13;

    subgraph cluster_v1_screens {
      label="Screens (src/pages/quote/)";
      style=filled;
      color="#E3F2FD";

      V1_1 [label="Screen 1: PrimaryDriverInfo.tsx\\n/quote/driver-info\\n\\nCollects ALL data:\\n‚Ä¢ Driver details (name, DOB, gender)\\n‚Ä¢ Address (line1, city, state, zip)\\n‚Ä¢ Vehicle (year, make, model, VIN)\\n\\n‚ö° CREATES QUOTE IMMEDIATELY\\nüíæ Writes to DB:\\n  ‚Ä¢ Quote table\\n  ‚Ä¢ Party, Person tables\\n  ‚Ä¢ Vehicle table\\n  ‚Ä¢ Premium calculated", fillcolor="#42A5F5", style=filled, fontcolor=white];

      V1_2 [label="Screen 2: AdditionalDrivers.tsx\\n/quote/additional-drivers/:quoteNumber\\n\\nAdd/edit additional drivers\\n\\nüíæ Writes to DB:\\n  ‚Ä¢ Person table (additional drivers)\\n  ‚Ä¢ Party Role table\\n  ‚Ä¢ Premium recalculated", fillcolor="#64B5F6", style=filled, fontcolor=white];

      V1_3 [label="Screen 3: VehiclesList.tsx\\n/quote/vehicles/:quoteNumber\\n\\nAdd/edit vehicles\\n\\nüíæ Writes to DB:\\n  ‚Ä¢ Vehicle table\\n  ‚Ä¢ Insurable Object table\\n  ‚Ä¢ Premium recalculated", fillcolor="#64B5F6", style=filled, fontcolor=white];

      V1_4 [label="Screen 4: VehicleConfirmation.tsx\\n/quote/vehicle-confirmation/:quoteNumber\\n\\nConfirm VIN decode results\\n\\nüíæ Reads from DB:\\n  ‚Ä¢ Vehicle details", fillcolor="#64B5F6", style=filled, fontcolor=white];

      V1_5 [label="Screen 5: CoverageSelection.tsx\\n/quote/coverage-selection/:quoteNumber\\n\\nSelect coverage levels:\\n‚Ä¢ Bodily injury, Property damage\\n‚Ä¢ Collision, Comprehensive\\n\\nüíæ Writes to DB:\\n  ‚Ä¢ Coverage tables (6 types)\\n  ‚Ä¢ Premium recalculated", fillcolor="#64B5F6", style=filled, fontcolor=white];

      V1_6 [label="Screen 6: QuoteResults.tsx\\n/quote/results/:quoteNumber\\n\\nüìä Shows final premium\\n‚Ä¢ 6-month total\\n‚Ä¢ Monthly payment\\n\\nüíæ Reads from DB:\\n  ‚Ä¢ Quote with all coverage", fillcolor="#1976D2", style=filled, fontcolor=white];
    }

    V1_Components [label="UI Components:\\n‚Ä¢ AppTemplate (Canary)\\n‚Ä¢ PageHeader (Canary)\\n‚Ä¢ Form components (Canary)\\n‚Ä¢ Standard layout", fillcolor="#90CAF9", style=filled];

    V1_Hooks [label="Uses Shared Hooks:\\n‚Ä¢ useCreateQuote()\\n‚Ä¢ useQuoteByNumber()\\n‚Ä¢ useUpdatePrimaryDriver()\\n‚Ä¢ useUpdateQuoteDrivers()\\n‚Ä¢ useUpdateQuoteVehicles()\\n‚Ä¢ useUpdateQuoteCoverage()", fillcolor="#90CAF9", style=filled];
  }

  subgraph cluster_v2 {
    label="V2 Flow - Tech Startup Redesign (/quote-v2/*)";
    style=filled;
    color="#E1BEE7";
    fontsize=13;

    V2_Guard [label="RouteGuard Component\\nexpectedFlow='tech-startup'\\n\\n‚úì Prevents cross-flow navigation", fillcolor="#CE93D8", style=filled, shape=hexagon];

    subgraph cluster_v2_screens {
      label="Screens (src/pages/quote-v2/)";
      style=filled;
      color="#F3E5F5";

      V2_1 [label="Screen 1: GetStarted.tsx\\n/quote-v2/get-started\\n\\nCollects:\\n‚Ä¢ First/Last name\\n‚Ä¢ Address\\n‚Ä¢ Date of birth\\n\\nüíæ Stores in sessionStorage\\n   'quote-v2-data'", fillcolor="#AB47BC", style=filled, fontcolor=white];

      V2_2 [label="Screen 2: EffectiveDate.tsx\\n/quote-v2/effective-date\\n\\nCollects:\\n‚Ä¢ Coverage start date\\n\\nüíæ Stores in sessionStorage\\n   'quote-v2-data'", fillcolor="#AB47BC", style=filled, fontcolor=white];

      V2_3 [label="Screen 3: EmailCollection.tsx\\n/quote-v2/email-collection\\n\\nCollects:\\n‚Ä¢ Email address\\n‚Ä¢ Mobile phone\\n\\nüíæ Stores in sessionStorage\\n   'quote-v2-data'", fillcolor="#AB47BC", style=filled, fontcolor=white];

      V2_4 [label="Screen 4: LoadingPrefill.tsx\\n/quote-v2/loading-prefill\\n\\n‚ö° CREATES QUOTE HERE\\nOrchestrates mock services:\\n‚Ä¢ VIN decode (useMockVINDecode)\\n‚Ä¢ MVR lookup (useMockDriverRecord)\\n‚Ä¢ Vehicle value (useMockVehicleValue)\\n‚Ä¢ Insurance history (useMockInsuranceHistory)\\n\\nüé¨ Animated loading screen\\n\\nüíæ Writes to DB:\\n  ‚Ä¢ Quote table\\n  ‚Ä¢ Party, Person tables\\n  ‚Ä¢ Vehicle table (from VIN decode)\\n  ‚Ä¢ Driver history (from MVR)\\n  ‚Ä¢ Premium calculated", fillcolor="#7B1FA2", style="filled,bold", fontcolor=white];

      V2_5 [label="Screen 5: Summary.tsx\\n/quote-v2/summary/:quoteNumber\\n\\nShows:\\n‚Ä¢ Driver summary (with edit modals)\\n‚Ä¢ Vehicle summary (with edit modals)\\n\\nEdit via:\\n‚Ä¢ EditDriverModal\\n‚Ä¢ EditVehicleModal\\n‚Ä¢ EditVehicleFinancedModal\\n\\nüíæ Writes to DB (on edit):\\n  ‚Ä¢ Person table (driver edits)\\n  ‚Ä¢ Vehicle table (vehicle edits)\\n  ‚Ä¢ Premium recalculated", fillcolor="#AB47BC", style=filled, fontcolor=white];

      V2_6 [label="Screen 6: Coverage.tsx\\n/quote-v2/coverage/:quoteNumber\\n\\n3 sections:\\n1. Liability (BI/PD limits)\\n2. Medical/PIP\\n3. Comp/Collision deductibles\\n\\nüíæ Writes to DB:\\n  ‚Ä¢ Coverage tables (6 types)\\n  ‚Ä¢ Premium recalculated\\n  ‚Ä¢ PriceSidebar updates", fillcolor="#AB47BC", style=filled, fontcolor=white];

      V2_7 [label="Screen 7: AddOns.tsx\\n/quote-v2/add-ons/:quoteNumber\\n\\nOptional coverage:\\n‚Ä¢ Rental reimbursement\\n‚Ä¢ Roadside assistance\\n\\nüíæ Writes to DB:\\n  ‚Ä¢ Coverage tables (add-ons)\\n  ‚Ä¢ Premium recalculated\\n  ‚Ä¢ PriceSidebar updates", fillcolor="#AB47BC", style=filled, fontcolor=white];

      V2_8 [label="Screen 8: LoadingValidation.tsx\\n/quote-v2/loading-validation/:quoteNumber\\n\\n‚úì Final validation\\nüé¨ Animated loading screen\\n\\nüíæ Reads from DB:\\n  ‚Ä¢ Full quote validation", fillcolor="#AB47BC", style=filled, fontcolor=white];

      V2_9 [label="Screen 9: Review.tsx\\n/quote-v2/review/:quoteNumber\\n\\nüìã Final review:\\n‚Ä¢ All details\\n‚Ä¢ Signature capture\\n‚Ä¢ Terms acceptance\\n\\nüíæ Writes to DB:\\n  ‚Ä¢ Signature table\\n  ‚Ä¢ Quote status updated", fillcolor="#9C27B0", style=filled, fontcolor=white];
    }

    subgraph cluster_v2_custom {
      label="Custom Components (src/pages/quote-v2/components/)";
      style=filled;
      color="#CE93D8";

      V2_Layout [label="TechStartupLayout.tsx\\n+ TechStartupLayout.css\\n\\n‚Ä¢ Provides QuoteContext\\n‚Ä¢ Purple gradient background\\n‚Ä¢ Card-based layout\\n‚Ä¢ Wraps all v2 screens", fillcolor="#8E24AA", style=filled, fontcolor=white];

      V2_Sidebar [label="PriceSidebar.tsx\\n\\nüìä Sticky price display:\\n‚Ä¢ 6-month total\\n‚Ä¢ Monthly payment\\n‚Ä¢ Real-time updates via\\n  useRecalculateQuote()", fillcolor="#8E24AA", style=filled, fontcolor=white];

      V2_Context [label="QuoteContext.tsx\\n(contexts/)\\n\\n‚Ä¢ Provides quote data\\n‚Ä¢ recalculatePremium()\\n‚Ä¢ Consumed by all screens", fillcolor="#6A1B9A", style=filled, fontcolor=white];
    }

    V2_Hooks [label="Uses Shared Hooks +:\\n‚Ä¢ useCreateQuote()\\n‚Ä¢ useQuoteByNumber()\\n‚Ä¢ useUpdateQuoteDrivers()\\n‚Ä¢ useUpdateQuoteVehicles()\\n‚Ä¢ useUpdateQuoteCoverage()\\n‚Ä¢ useRecalculateQuote() ‚ö°\\n‚Ä¢ useMockVINDecode() ‚ö°\\n‚Ä¢ useMockDriverRecord() ‚ö°", fillcolor="#BA68C8", style=filled];
  }

  subgraph cluster_shared {
    label="Shared Infrastructure (100% Common)";
    style=filled;
    color="#C8E6C9";
    fontsize=13;

    subgraph cluster_frontend_shared {
      label="Frontend Shared (src/)";
      style=filled;
      color="#E8F5E9";

      SharedHooks [label="hooks/useQuote.ts\\nTanStack Query Hooks:\\n\\n‚Ä¢ useQuote()\\n‚Ä¢ useQuoteByNumber()\\n‚Ä¢ useCreateQuote()\\n‚Ä¢ useUpdatePrimaryDriver()\\n‚Ä¢ useUpdateQuoteDrivers()\\n‚Ä¢ useUpdateQuoteVehicles()\\n‚Ä¢ useUpdateQuoteCoverage()\\n‚Ä¢ useRecalculateQuote()", fillcolor="#66BB6A", style=filled, fontcolor=white];

      ApiClient [label="services/quote-api.ts\\nHTTP Client:\\n\\n‚Ä¢ createQuote()\\n‚Ä¢ getQuoteById()\\n‚Ä¢ getQuoteByNumber()\\n‚Ä¢ updatePrimaryDriver()\\n‚Ä¢ updateDrivers()\\n‚Ä¢ updateVehicles()\\n‚Ä¢ updateCoverage()\\n‚Ä¢ recalculateQuote()", fillcolor="#66BB6A", style=filled, fontcolor=white];

      MockHooks [label="hooks/useMockServices.ts\\n\\n‚Ä¢ useMockVINDecode()\\n‚Ä¢ useMockInsuranceHistory()\\n‚Ä¢ useMockVehicleValue()\\n‚Ä¢ useMockDriverRecord()", fillcolor="#66BB6A", style=filled, fontcolor=white];
    }

    subgraph cluster_backend {
      label="Backend (backend/src/)";
      style=filled;
      color="#E8F5E9";

      Controller [label="api/routes/quotes.controller.ts\\nREST Endpoints:\\n\\nPOST   /api/v1/quotes\\nGET    /api/v1/quotes/:id\\nGET    /api/v1/quotes/reference/:number\\nPUT    /api/v1/quotes/:number/primary-driver\\nPUT    /api/v1/quotes/:number/drivers\\nPUT    /api/v1/quotes/:number/vehicles\\nPUT    /api/v1/quotes/:number/coverage", fillcolor="#4CAF50", style=filled, fontcolor=white];

      QuoteService [label="services/quote/quote.service.ts\\nBusiness Logic:\\n\\n‚Ä¢ Quote creation\\n‚Ä¢ Quote updates\\n‚Ä¢ Validation\\n‚Ä¢ Calls RatingEngine", fillcolor="#388E3C", style=filled, fontcolor=white];

      RatingEngine [label="services/rating-engine/\\nPremium Calculation:\\n\\n‚Ä¢ Base rates by state\\n‚Ä¢ Age/gender factors\\n‚Ä¢ Vehicle rating\\n‚Ä¢ Multi-vehicle discount\\n‚Ä¢ Discounts & surcharges", fillcolor="#2E7D32", style=filled, fontcolor=white];

      MockServices [label="services/mock-services/\\nSimulated Integrations:\\n\\n‚Ä¢ VIN decoder\\n‚Ä¢ MVR lookup\\n‚Ä¢ Vehicle valuation\\n‚Ä¢ Insurance history\\n‚Ä¢ Email service", fillcolor="#2E7D32", style=filled, fontcolor=white];
    }

    DB [label="Database\\ndatabase/schema/\\n\\n31 OMG-compliant tables:\\n‚Ä¢ Quote, Policy, Coverage\\n‚Ä¢ Party, Person, Vehicle\\n‚Ä¢ Account, Payment, Claim\\n‚Ä¢ Rating tables, etc.\\n\\nNeon PostgreSQL", shape=cylinder, fillcolor="#1B5E20", style=filled, fontcolor=white];
  }

  subgraph cluster_post_quote {
    label="Post-Quote Flows (Shared by Both V1 and V2)";
    style=filled;
    color="#FFF9C4";
    fontsize=13;

    subgraph cluster_binding {
      label="Policy Binding";
      style=filled;
      color="#FFF59D";

      Binding [label="Payment & Binding\\n(Both flows proceed here)\\n\\nPOST /api/v1/policies/bind\\n\\nCollects:\\n‚Ä¢ Payment method (card/bank)\\n‚Ä¢ Billing frequency (monthly/6-month)\\n‚Ä¢ Card details (number, expiry, CVV)\\n\\nüíæ Writes to DB:\\n  ‚Ä¢ Policy table (from quote)\\n  ‚Ä¢ Agreement table\\n  ‚Ä¢ Account table\\n  ‚Ä¢ Payment table\\n  ‚Ä¢ Document generation triggered", fillcolor="#FFD54F", style=filled];
    }

    subgraph cluster_documents {
      label="Document Generation";
      style=filled;
      color="#FFF59D";

      DocGen [label="Document Service\\nbackend/src/services/document-service/\\n\\nGenerates PDF documents:\\n‚Ä¢ Policy Declarations Page\\n‚Ä¢ Coverage Summary\\n‚Ä¢ Terms & Conditions\\n‚Ä¢ ID Cards (per vehicle)\\n\\nüíæ Writes to DB:\\n  ‚Ä¢ Document table\\n  ‚Ä¢ Links to Policy\\n\\nGET /api/v1/documents/:id", fillcolor="#FFB300", style=filled];
    }

    subgraph cluster_portal {
      label="Self-Service Portal";
      style=filled;
      color="#FFF59D";

      Portal_Entry [label="Portal Access\\n/portal/:policyNumber\\n\\n‚ö†Ô∏è NO AUTHENTICATION (Demo mode)\\nAccess via URL with policy number\\n\\nExample:\\n/portal/POL-ABC123", fillcolor="#FF6F00", style=filled, fontcolor=white];

      Portal_Dashboard [label="Dashboard Page\\nsrc/pages/portal/Dashboard.tsx\\n\\nGET /api/v1/portal/:policyNumber/dashboard\\n\\nShows:\\n‚Ä¢ Policy status & expiry\\n‚Ä¢ Coverage summary\\n‚Ä¢ Recent payments\\n‚Ä¢ Active claims\\n\\nüíæ Reads from DB:\\n  ‚Ä¢ Policy, Coverage tables\\n  ‚Ä¢ Payment table\\n  ‚Ä¢ Claim table", fillcolor="#FFA726", style=filled];

      Portal_Policy [label="Policy Details Page\\nsrc/pages/portal/PolicyDetails.tsx\\n\\nGET /api/v1/portal/:policyNumber/policy\\n\\nShows:\\n‚Ä¢ Full policy details\\n‚Ä¢ All drivers & vehicles\\n‚Ä¢ Coverage breakdown\\n‚Ä¢ Download documents\\n\\nüíæ Reads from DB:\\n  ‚Ä¢ Policy, Agreement tables\\n  ‚Ä¢ Person, Vehicle tables\\n  ‚Ä¢ Coverage tables\\n  ‚Ä¢ Document table", fillcolor="#FFA726", style=filled];

      Portal_Billing [label="Billing Page\\nsrc/pages/portal/Billing.tsx\\n\\nGET /api/v1/portal/:policyNumber/billing\\n\\nShows:\\n‚Ä¢ Payment history\\n‚Ä¢ Next payment due\\n‚Ä¢ Billing frequency\\n‚Ä¢ Payment method\\n\\nüíæ Reads from DB:\\n  ‚Ä¢ Payment table\\n  ‚Ä¢ Account table", fillcolor="#FFA726", style=filled];

      Portal_Claims [label="Claims Page\\nsrc/pages/portal/Claims.tsx\\n\\nGET /api/v1/portal/:policyNumber/claims\\n\\nShows:\\n‚Ä¢ Active claims\\n‚Ä¢ Claim status\\n‚Ä¢ Claim history\\n‚Ä¢ File new claim (future)\\n\\nüíæ Reads from DB:\\n  ‚Ä¢ Claim table\\n  ‚Ä¢ Claim Party Role table\\n  ‚Ä¢ Claim Event table", fillcolor="#FFA726", style=filled];
    }
  }

  Start -> FlowTracker [label="User clicks flow"];
  FlowTracker -> V1_1 [label="setActiveFlow('classic')\\nNavigate to /quote/driver-info", color="#1976D2", penwidth=2];
  FlowTracker -> V2_Guard [label="setActiveFlow('tech-startup')\\nNavigate to /quote-v2/*", color="#6A1B9A", penwidth=2];
  V2_Guard -> V2_1 [label="Route allowed", color="#6A1B9A", penwidth=1.5];

  V1_1 -> V1_2 [label="Navigate with\\nquoteNumber", color="#1976D2", penwidth=1.5];
  V1_2 -> V1_3 [label="Navigate", color="#1976D2", penwidth=1.5];
  V1_3 -> V1_4 [label="Navigate", color="#1976D2", penwidth=1.5];
  V1_4 -> V1_5 [label="Navigate", color="#1976D2", penwidth=1.5];
  V1_5 -> V1_6 [label="Navigate", color="#1976D2", penwidth=1.5];

  V2_1 -> V2_2 [label="sessionStorage\\n'quote-v2-data'", color="#6A1B9A", penwidth=1.5];
  V2_2 -> V2_3 [label="sessionStorage", color="#6A1B9A", penwidth=1.5];
  V2_3 -> V2_4 [label="sessionStorage", color="#6A1B9A", penwidth=1.5];
  V2_4 -> V2_5 [label="Navigate with\\nquoteNumber", color="#6A1B9A", penwidth=1.5];
  V2_5 -> V2_6 [label="Navigate", color="#6A1B9A", penwidth=1.5];
  V2_6 -> V2_7 [label="Navigate", color="#6A1B9A", penwidth=1.5];
  V2_7 -> V2_8 [label="Navigate", color="#6A1B9A", penwidth=1.5];
  V2_8 -> V2_9 [label="Navigate", color="#6A1B9A", penwidth=1.5];

  V1_1 -> SharedHooks [label="useCreateQuote()\\nuseUpdatePrimaryDriver()", color="#1976D2", style=dotted];
  V1_2 -> SharedHooks [label="useUpdateQuoteDrivers()", color="#1976D2", style=dotted];
  V1_3 -> SharedHooks [label="useUpdateQuoteVehicles()", color="#1976D2", style=dotted];
  V1_5 -> SharedHooks [label="useUpdateQuoteCoverage()", color="#1976D2", style=dotted];

  V2_4 -> SharedHooks [label="useCreateQuote()", color="#6A1B9A", style=dotted];
  V2_4 -> MockHooks [label="All mock hooks", color="#6A1B9A", style=dotted];
  V2_5 -> SharedHooks [label="useQuoteByNumber()\\nuseUpdateDrivers()\\nuseUpdateVehicles()", color="#6A1B9A", style=dotted];
  V2_6 -> SharedHooks [label="useUpdateQuoteCoverage()\\nuseRecalculateQuote()", color="#6A1B9A", style=dotted];
  V2_7 -> SharedHooks [label="useUpdateQuoteCoverage()\\nuseRecalculateQuote()", color="#6A1B9A", style=dotted];

  V2_Layout -> V2_Context [label="Provides", color="#6A1B9A"];
  V2_Sidebar -> V2_Context [label="Consumes", color="#6A1B9A"];
  V2_Layout -> V2_1 [label="Wraps", color="#6A1B9A", style=dotted];
  V2_Layout -> V2_5 [label="Wraps", color="#6A1B9A", style=dotted];
  V2_Layout -> V2_6 [label="Wraps", color="#6A1B9A", style=dotted];

  SharedHooks -> ApiClient [label="Wraps HTTP calls", color="#2E7D32"];
  MockHooks -> ApiClient [label="Wraps HTTP calls", color="#2E7D32"];
  ApiClient -> Controller [label="HTTP requests", color="#2E7D32"];
  Controller -> QuoteService [label="Delegates to service", color="#2E7D32"];
  QuoteService -> RatingEngine [label="Calculate premium", color="#2E7D32"];
  QuoteService -> DB [label="CRUD operations", color="#2E7D32"];
  RatingEngine -> DB [label="Read rating tables", color="#2E7D32"];
  MockServices -> DB [label="Write mock data", color="#2E7D32"];
  Controller -> MockServices [label="Calls for prefill", color="#2E7D32", style=dashed];

  V1_6 -> Binding [label="User clicks\\n'Proceed to bind'", color="#1976D2", penwidth=2];
  V2_9 -> Binding [label="User clicks\\n'Proceed to bind'", color="#6A1B9A", penwidth=2];

  Binding -> DocGen [label="Triggers on\\npolicy creation", color="#F57F17", penwidth=1.5];
  Binding -> Portal_Entry [label="Policy created\\nUser can access portal", color="#F57F17", penwidth=1.5];

  DocGen -> DB [label="Write documents", color="#F57F17", style=dashed];

  Portal_Entry -> Portal_Dashboard [label="Navigate to\\n/portal/:policyNumber/dashboard", color="#FF6F00", penwidth=1.5];
  Portal_Dashboard -> Portal_Policy [label="Navigate", color="#FF6F00"];
  Portal_Dashboard -> Portal_Billing [label="Navigate", color="#FF6F00"];
  Portal_Dashboard -> Portal_Claims [label="Navigate", color="#FF6F00"];

  Portal_Policy -> DB [label="Read policy data", color="#FF6F00", style=dotted];
  Portal_Billing -> DB [label="Read billing data", color="#FF6F00", style=dotted];
  Portal_Claims -> DB [label="Read claims data", color="#FF6F00", style=dotted];
  Portal_Dashboard -> DB [label="Read dashboard data", color="#FF6F00", style=dotted];

  Portal_Policy -> DocGen [label="Download\\nPDF documents", color="#FF6F00", style=dashed];

  subgraph cluster_legend {
    label="Legend";
    style=filled;
    color=white;
    fontsize=11;

    L1 [label="V1 Flow", fillcolor="#64B5F6", style=filled, fontcolor=white];
    L2 [label="V2 Flow", fillcolor="#AB47BC", style=filled, fontcolor=white];
    L3 [label="Shared Code", fillcolor="#66BB6A", style=filled, fontcolor=white];
    L4 [label="Post-Quote (Binding/Portal)", fillcolor="#FFD54F", style=filled];

    L1 -> L2 [label="Solid = Navigation/Flow", style=solid];
    L2 -> L3 [label="Dotted = Uses/Calls", style=dotted];
    L3 -> L4 [label="Dashed = Triggers/Downloads", style=dashed];
  }
}`;

        // Initialize and render the graph
        async function renderGraph() {
            try {
                const container = document.getElementById('graphContainer');

                // Initialize graphviz
                if (!graphviz) {
                    graphviz = await window["@hpcc-js/wasm"].Graphviz.load();
                }

                // Render to SVG
                const svg = graphviz.dot(dotSource);

                // Clear loading and insert SVG
                container.innerHTML = svg;

                // Get the SVG element and make it responsive
                const svgElement = container.querySelector('svg');
                if (svgElement) {
                    // Store original dimensions
                    const width = svgElement.getAttribute('width');
                    const height = svgElement.getAttribute('height');

                    // Make responsive
                    svgElement.removeAttribute('width');
                    svgElement.removeAttribute('height');
                    svgElement.style.maxWidth = '100%';
                    svgElement.style.height = 'auto';

                    svgContent = svgElement;
                }

                // Enable panning
                enablePanning();
            } catch (error) {
                console.error('Error rendering graph:', error);
                const container = document.getElementById('graphContainer');
                container.innerHTML = `
                    <div class="error-message">
                        <h3>Error Rendering Graph</h3>
                        <p><strong>Error:</strong> ${error.message || 'Unknown error'}</p>
                        <p>Please check the browser console for more details.</p>
                        <p>Try opening the original "flow map.dot" file with Graphviz instead.</p>
                    </div>
                `;
            }
        }

        function enablePanning() {
            const container = document.getElementById('graphContainer');
            const svg = container.querySelector('svg');
            if (!svg) return;

            let isPanning = false;
            let startX, startY, scrollLeft, scrollTop;

            container.addEventListener('mousedown', (e) => {
                isPanning = true;
                startX = e.pageX - container.offsetLeft;
                startY = e.pageY - container.offsetTop;
                scrollLeft = container.scrollLeft;
                scrollTop = container.scrollTop;
            });

            container.addEventListener('mouseleave', () => {
                isPanning = false;
            });

            container.addEventListener('mouseup', () => {
                isPanning = false;
            });

            container.addEventListener('mousemove', (e) => {
                if (!isPanning) return;
                e.preventDefault();
                const x = e.pageX - container.offsetLeft;
                const y = e.pageY - container.offsetTop;
                const walkX = (x - startX) * 1.5;
                const walkY = (y - startY) * 1.5;
                container.scrollLeft = scrollLeft - walkX;
                container.scrollTop = scrollTop - walkY;
            });
        }

        function zoomIn() {
            currentZoom = Math.min(3, currentZoom + 0.1);
            applyZoom();
        }

        function zoomOut() {
            currentZoom = Math.max(0.1, currentZoom - 0.1);
            applyZoom();
        }

        function resetZoom() {
            currentZoom = 1;
            applyZoom();
            document.getElementById('graphContainer').scrollTop = 0;
            document.getElementById('graphContainer').scrollLeft = 0;
        }

        function applyZoom() {
            const svg = document.querySelector('#graphContainer svg');
            if (svg) {
                svg.style.transform = `scale(${currentZoom})`;
                svg.style.transformOrigin = 'top left';
            }
        }

        function downloadSVG() {
            const svg = document.querySelector('#graphContainer svg');
            if (!svg) {
                alert('No graph available to download');
                return;
            }

            const serializer = new XMLSerializer();
            const svgString = serializer.serializeToString(svg);
            const blob = new Blob([svgString], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'flow-map.svg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Render on load
        window.addEventListener('DOMContentLoaded', renderGraph);
    </script>
</body>
</html>
